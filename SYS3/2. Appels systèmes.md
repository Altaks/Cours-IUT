
>[!important] Les appels systèmes, qu'est ce que c'est ?
>Pour accéder aux services du système d'exploitation, un programme doit effectuer un appel système (`syscall`) qui consiste en :
>- Basculer en mode "noyau" (*kernel mode*)
>- Invoquer le système d'exploitation
>- Revenir en mode "utilisateur"
>- Retourner le contrôle au programme utilisateur.

Par exemple, lors de la lecture ou de l'écriture sur le disque dur, le programme décide de ce qui doit être écrit et ou, mais c'est le kernel qui va réaliser cette tâche. 

---

#### Exemple avec le compilateur C : La fonction `read`

La fonction `read` est décrite ainsi : 

```c
ssize_t read (int __fd, void *__buf, size_t __nbytes)
```

On aperçoit qu'elle prend en paramètres :

- `int __fd` qui est le [**file descriptor**](https://fr.wikipedia.org/wiki/Descripteur_de_fichier) *(voir fonction `open`)* du fichier que l'on souhaite lire
- `void* __buf` qui est un [**buffer**](https://fr.wikipedia.org/wiki/M%C3%A9moire_tampon) qui va recevoir les informations lues, le buffer est de type `void*` mais généralement il va accueillir le type `char**` aussi écrit `string*` en C++.
- `size_t __nbytes` qui va correspondre au **nombre d'octets** (1 octet = 1 caractère) que la fonction `read` devra lire. Ce nombre doit correspondre au maximum à la taille du buffer, sinon on risque un [**buffer overflow**](https://fr.wikipedia.org/wiki/D%C3%A9passement_de_tampon) qui pourrait altérer d'autres variables. 

Et qu'elle retourne un nombre de type `ssize_t`. Vous pourrez cependant traiter ces types comme des `int`.

###### Déroulement d'un appel de `cpt = read(df, buf, nbytes)`

$$
\operatorname{read(df, buf, nbytes)} \rightarrow
\begin{cases}
1.& \text{Empiler nbytes} \\
2.& \text{Empiler \&buf} \\
3.& \text{Empiler df} \\
4.& \text{Appeler read()} \\
5.& \textcolor{orange}{\text{Placement du code de read() dans un registre}} \\
6.& \textcolor{orange}{\text{Déroutement vers le noyau, basculer en mode noyau}} \\
7.& \textcolor{salmon}{\text{Le code du noyau examine le numéro d'appel système (syscall)}} \\
& \textcolor{salmon}{\text{Utilisation d'une table de pointeurs indexés sur les syscalls}} \\
8.& \textcolor{salmon}{\text{Execution de l'appel système}} \\
9.& \textcolor{salmon}{\text{Rendre le contrôle à la fonction read de la bibliothèque unistd.h}} \\
10.& \textcolor{orange}{\text{Rendre le contrôle au programme utlisateur}}
\end{cases}
$$
$$
\begin{align}
\textcolor{orange}{\blacksquare} &: \text{Passage en mode kernel}\\
\textcolor{salmon}{\blacksquare} & : \text{Mode kernel, le système d'exploitation gère les opérations}
\end{align}
$$

> [!example] Quelques exemples d'appels systèmes disponibles sur Unix/Linux
>
> Gestion des fichiers : 
> - open, close, read, write, dup, dup2, stat, ...
>
> Gestion des processus : 
> - fork, pipe, exec, execve, execlp, exit, ...
>
> Communications inter-machines 
> - socket, bind, listen, connect, accept, send, recv, write, read, sendto, recvfrom, closes, gethostbyname, gethostbyaddr

