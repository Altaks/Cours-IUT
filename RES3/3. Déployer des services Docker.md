### Les [images](https://hub.docker.com/search?q=&type=image) 

Les images sont un ensemble de couches logicielles composées pour faire fonctionner un service :
- Elles n'ont pas d'état (elles ne changent jamais sauf en cas de changement de version)
- Elles sont identifiées par un **ID Docker**
- Elles sont identifiées par un couple **`repository/tag`**, quelques exemples :
	- `ubuntu/nginx`
	- `ubuntu/squid`
	- `ubuntu/apache2`
	- `mysql/mysql-server`
	- `mysql/mysql-cluster`
	- `mysql/mysql-operator`
	- `google/cadvisor`
	- ...
- Elles servent de base aux containers

---

### Les conteneurs

Les containers sont des instances/runtimes d'**images** docker : 
- Ils dépendent d'**images**
- Ils disposent d'un **environnement isolé** et ont des **instructions d'exécution** (quels programmes démarrent quand le container démarre)
- On un **statut** : `CREATED, RUNNING, RESTARTING, PAUSED, EXITED, DEAD`
- Sont identifiés par un **nom**
- Sont identifiés par un **ID Docker**

---

### Le registre Docker

Un des grands avantages de Docker est la facilité avec laquelle nous pouvons utiliser des images prêtes à l'emploi. 

Il existe un site spécialisé : [Le Docker Hub](https://hub.docker.com) ou l'on peut explorer les images a disposition et publier les nôtres.

---

### Exemple : L'image [Hello-World](https://hub.docker.com/_/hello-world)

Une des meilleures méthodes pour être certain que notre installation Docker est fonctionnelle est de lancer un container, et Docker y a pensé en créant une image de "test"

Une fois Docker installé, vous pouvez exécuter la commande suivante : 

```bash
docker run hello-world
```

Ce qui vous renverra une sortie sur le terminal similaire à : 

```
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
719385e32844: Pull complete 
Digest: sha256:4f53e2564790c8e7856ec08e384732aa38dc43c52f02952483e3f003afbf23db
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
```

**Si on décompose l'output ci-dessus on observe que :**

- Le Docker Client envoie la commande au Docker Daemon
- Il remarque qu'il n'a pas l'image `hello-world` localement (sur l'hôte) et va **récupérer l'image** sur le registre (Docker Hub)
- Il **vérifie** l'intégrité de l'image récupérée via le **hash SHA256**.
- Le Docker Daemon **créé un nouveau container**, celui-ci va exécuter un script qui va envoyer un message sur la console
- Le message est streamé vers le Docker Client et l'**affiche dans la console** (la sortie standard)
- Le script se termine, le container s'arrête tout seul

---

### Exemple : Exécuter un environnement Linux

Pour lancer un container qui contiendra un environnement Linux, on peut exécuter la commande suivante : 

```bash
docker run -it -p 80:80 --name ubuntu ubuntu
```

Analysons la commande :

| Arguments       | Description                                                  | Syntaxe              |
| --------------- | ------------------------------------------------------------ | --------------------------------- |
| `docker run`    | On va lancer un container d'après une image                  |                                   |
| `-it`           | On le lance en mode intéractif                               |                                   |
| `-p 80:80`      | On va connecter le port 80 de l'hôte au port 80 du container | `-p <host-side>:<container-side>` |
| `--name ubuntu` | On nomme le container avec un nom personnalisé : `ubuntu`    | `--name <name>`                   |
| `ubuntu`        | On choisit l'image `ubuntu`                                  | `docker run [options] <image>`    |

On obtient dans la console ceci : 

```
Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
445a6a12be2b: Pull complete 
Digest: sha256:aabed3296a3d45cede1dc866a24476c4d7e093aa806263c27ddaadbdce3c1054
Status: Downloaded newer image for ubuntu:latest
root@c61f97dcb064:/# 
```

On remarque qu'on arrive sur une console avec l'utilisateur `root` sur le container. Vous venez de lancer un Ubuntu dans un container !

Une fois le conteneur lancé, on peut se servir des outils standards d'Ubuntu : 

```
root@c61f97dcb064:/# ls /
bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

On peut alors par exemple installer Python3 dans le container : 

```
apt update && apt install python3 -y
```

Puis lancer la console Python3 : 

```
root@c61f97dcb064:/# python3
Python 3.10.12 (main, Jun 11 2023, 05:26:28) [GCC 11.4.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> 
```

*On peut quitter le mode interactif du container avec le raccourci `Ctrl-P + Ctrl-Q` sans pour autant éteindre le container*

**Depuis l'hôte**, on peut aussi voir **quels processus** sont en cours **dans le conteneur** : 

```bash
docker top ubuntu
```

*Pour se reconnecter à la console du container, vous pouvez utiliser la commande suivante*

```bash
docker attach ubuntu
```

On se retrouve alors dans le mode interactif à nouveau

```
root@c61f97dcb064:/# 
```

>[!example] Si l'on souhaite installer un serveur Web
>
Si l'on souhaite installer un serveur web : 
> 
> ```bash
apt install nginx
service nginx start
> ```
> 
> Depuis l'hôte, le serveur est alors accessible depuis le port 80.
> Cette installation (et cet exemple) est minimale, mais vous pourrez trouver sur Docker Hub des images pour tous les services dont vous pourriez avoir besoin dans le futur.

---

### Gérer les containers et les images

##### Lister les containers actifs : `docker ps`

```
CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS                NAMES
84bc8436dfc7   ubuntu    "/bin/bash"   25 seconds ago   Up 24 seconds   0.0.0.0:80->80/tcp   ubuntu
```
##### Lister tous les containers présents : `docker ps --all`

```
CONTAINER ID   IMAGE                COMMAND                  CREATED              STATUS                     PORTS                NAMES
84bc8436dfc7   ubuntu               "/bin/bash"              About a minute ago   Up About a minute          0.0.0.0:80->80/tcp   ubuntu
71b19a829ddf   busybox              "sh"                     2 minutes ago        Exited (0) 2 minutes ago                        priceless_wright
f0b191eac39f   busybox              "sh"                     2 minutes ago        Exited (0) 2 minutes ago                        tender_tu
4d29b0082809   stack-php-main-web   "/bin/sh -c '/usr/lo…"   6 days ago           Exited (137) 4 days ago                         iut-web
d6d96bd05677   stack-php-main-php   "docker-php-entrypoi…"   6 days ago           Exited (137) 4 days ago                         iut-php
07bdfd5308a9   stack-php-main-db    "docker-entrypoint.s…"   6 days ago           Exited (137) 4 days ago
```
##### Démarrer un container `docker start <id-container/name>`

```
$ docker start ubuntu
ubuntu
```
##### Arrêter un container : `docker stop <id-container/name>`

```
$ docker stop ubuntu
ubuntu
```
##### Supprimer un container `docker rm <id-container/name>`

```
$ docker rm ubuntu
ubuntu
```
##### Lister les images disponibles `docker images`

```
REPOSITORY                                TAG       IMAGE ID       CREATED        SIZE
stack-php-main-php                        latest    618ca0113da5   6 days ago     338MB
stack-php-main-db                         latest    bd70c909e7cc   6 days ago     384MB
stack-php-main-web                        latest    4c229479e990   6 days ago     55MB
ubuntu                                    latest    c6b84b685f35   4 weeks ago    77.8MB
busybox                                   latest    a416a98b71e2   2 months ago   4.26MB
docker/welcome-to-docker                  latest    912b66cfd46e   2 months ago   13.4MB
artifision/live-charts-docker-extension   1.0.0     8acff91fef41   3 months ago   8.67MB
```
##### Supprimer une image `docker image rm <id-image/name>` ou `docker rmi <id-image/name>`

```
Untagged: ubuntu:latest
Untagged: ubuntu@sha256:aabed3296a3d45cede1dc866a24476c4d7e093aa806263c27ddaadbdce3c1054
Deleted: sha256:c6b84b685f35f1a5d63661f5d4aa662ad9b7ee4f4b8c394c022f25023c907b65
Deleted: sha256:dc0585a4b8b71f7f4eb8f2e028067f88aec780d9ab40c948a8d431c1aeadeeb5
```

---

### Inspecter et monitorer 

##### Voir la gestion des fichiers docker : `docker system df`

```
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          6         3         802.9MB   26.33MB (3%)
Containers      3         0         128.7kB   128.7kB (100%)
Local Volumes   1         1         154.6MB   0B (0%)
Build Cache     61        0         96.1MB    96.1MB
```

##### Faire la liste des containers et observer leur statut : `docker container ls -as`

```
CONTAINER ID   IMAGE                COMMAND                  CREATED      STATUS                    PORTS     NAMES     SIZE
4d29b0082809   stack-php-main-web   "/bin/sh -c '/usr/lo…"   6 days ago   Exited (137) 4 days ago             iut-web   129kB (virtual 55.1MB)
d6d96bd05677   stack-php-main-php   "docker-php-entrypoi…"   6 days ago   Exited (137) 4 days ago             iut-php   0B (virtual 338MB)
07bdfd5308a9   stack-php-main-db    "docker-entrypoint.s…"   6 days ago   Exited (137) 4 days ago             iut-db    2B (virtual 384MB)
```
##### Obtenir les processus en cours dans le container : `docker top <id-container/name>`

```
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                3932                3906                0                   06:31               ?                   00:00:00            /bin/bash

```
##### Obtenir un dump d'inspection d'un container : `docker inspect <id-container/name>`

```json
[
    {
        "Id": "f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7",
        "Created": "2023-09-18T06:31:40.40153416Z",
        "Path": "/bin/bash",
        "Args": [],
        "State": {
            "Status": "running",
            "Running": true,
            "Paused": false,
            "Restarting": false,
            "OOMKilled": false,
            "Dead": false,
            "Pid": 3932,
            "ExitCode": 0,
            "Error": "",
            "StartedAt": "2023-09-18T06:31:40.638923876Z",
            "FinishedAt": "0001-01-01T00:00:00Z"
        },
        "Image": "sha256:c6b84b685f35f1a5d63661f5d4aa662ad9b7ee4f4b8c394c022f25023c907b65",
        "ResolvConfPath": "/var/lib/docker/containers/f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7/resolv.conf",
        "HostnamePath": "/var/lib/docker/containers/f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7/hostname",
        "HostsPath": "/var/lib/docker/containers/f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7/hosts",
        "LogPath": "/var/lib/docker/containers/f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7/f4db6d60e9b5c420053f8a1af3e7e7042c11876ec9a85e17ec8164335254f5c7-json.log",
        "Name": "/ubuntu",
        "RestartCount": 0,
        "Driver": "overlay2",
        "Platform": "linux",
        "MountLabel": "",
        "ProcessLabel": "",
        "AppArmorProfile": "",
        "ExecIDs": null,
        "HostConfig": {
            "Binds": null,
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
            "NetworkMode": "default",
            "PortBindings": {
                "80/tcp": [
                    {
                        "HostIp": "",
                        "HostPort": "80"
                    }
                ]
            },
            "RestartPolicy": {
                "Name": "no",
                "MaximumRetryCount": 0
            },
            "AutoRemove": false,
            "VolumeDriver": "",
            "VolumesFrom": null,
            "ConsoleSize": [
                47,
                94
            ],
            "CapAdd": null,
            "CapDrop": null,
            "CgroupnsMode": "private",
            "Dns": [],
            "DnsOptions": [],
            "DnsSearch": [],
            "ExtraHosts": null,
            "GroupAdd": null,
            "IpcMode": "private",
            "Cgroup": "",
            "Links": null,
            "OomScoreAdj": 0,
            "PidMode": "",
            "Privileged": false,
            "PublishAllPorts": false,
            "ReadonlyRootfs": false,
            "SecurityOpt": null,
            "UTSMode": "",
            "UsernsMode": "",
            "ShmSize": 67108864,
            "Runtime": "runc",
            "Isolation": "",
            "CpuShares": 0,
            "Memory": 0,
            "NanoCpus": 0,
            "CgroupParent": "",
            "BlkioWeight": 0,
            "BlkioWeightDevice": [],
            "BlkioDeviceReadBps": [],
            "BlkioDeviceWriteBps": [],
            "BlkioDeviceReadIOps": [],
            "BlkioDeviceWriteIOps": [],
            "CpuPeriod": 0,
            "CpuQuota": 0,
            "CpuRealtimePeriod": 0,
            "CpuRealtimeRuntime": 0,
            "CpusetCpus": "",
            "CpusetMems": "",
            "Devices": [],
            "DeviceCgroupRules": null,
            "DeviceRequests": null,
            "MemoryReservation": 0,
            "MemorySwap": 0,
            "MemorySwappiness": null,
            "OomKillDisable": null,
            "PidsLimit": null,
            "Ulimits": null,
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0,
            "MaskedPaths": [
                "/proc/asound",
                "/proc/acpi",
                "/proc/kcore",
                "/proc/keys",
                "/proc/latency_stats",
                "/proc/timer_list",
                "/proc/timer_stats",
                "/proc/sched_debug",
                "/proc/scsi",
                "/sys/firmware"
            ],
            "ReadonlyPaths": [
                "/proc/bus",
                "/proc/fs",
                "/proc/irq",
                "/proc/sys",
                "/proc/sysrq-trigger"
            ]
        },
        "GraphDriver": {
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/f108a3ece19540c55fafbad5244238c44040d7e64a8bfe65fff0051b06e7d301-init/diff:/var/lib/docker/overlay2/aa037ede2f8b5019fc3dcc6fe55f5016f67e1527dfa4be27e520f49db26cf672/diff",
                "MergedDir": "/var/lib/docker/overlay2/f108a3ece19540c55fafbad5244238c44040d7e64a8bfe65fff0051b06e7d301/merged",
                "UpperDir": "/var/lib/docker/overlay2/f108a3ece19540c55fafbad5244238c44040d7e64a8bfe65fff0051b06e7d301/diff",
                "WorkDir": "/var/lib/docker/overlay2/f108a3ece19540c55fafbad5244238c44040d7e64a8bfe65fff0051b06e7d301/work"
            },
            "Name": "overlay2"
        },
        "Mounts": [],
        "Config": {
            "Hostname": "f4db6d60e9b5",
            "Domainname": "",
            "User": "",
            "AttachStdin": true,
            "AttachStdout": true,
            "AttachStderr": true,
            "ExposedPorts": {
                "80/tcp": {}
            },
            "Tty": true,
            "OpenStdin": true,
            "StdinOnce": true,
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            ],
            "Cmd": [
                "/bin/bash"
            ],
            "Image": "ubuntu",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {
                "org.opencontainers.image.ref.name": "ubuntu",
                "org.opencontainers.image.version": "22.04"
            }
        },
        "NetworkSettings": {
            "Bridge": "",
            "SandboxID": "4080b1f9f4e66714325730ecaeeb0e525b2fa06bb2f8f91e8384bd2ab3e040a3",
            "HairpinMode": false,
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "Ports": {
                "80/tcp": [
                    {
                        "HostIp": "0.0.0.0",
                        "HostPort": "80"
                    }
                ]
            },
            "SandboxKey": "/var/run/docker/netns/4080b1f9f4e6",
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "EndpointID": "08c6d9594c2d395c40057d78a1c075e09a397f1d2db34e635829e5921fdc7059",
            "Gateway": "172.17.0.1",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "172.17.0.2",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
            "MacAddress": "02:42:ac:11:00:02",
            "Networks": {
                "bridge": {
                    "IPAMConfig": null,
                    "Links": null,
                    "Aliases": null,
                    "NetworkID": "7fff1de14d177df3c14daf47d8bb6cadedb03febea7d1c87959b02d99dc5af06",
                    "EndpointID": "08c6d9594c2d395c40057d78a1c075e09a397f1d2db34e635829e5921fdc7059",
                    "Gateway": "172.17.0.1",
                    "IPAddress": "172.17.0.2",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:ac:11:00:02",
                    "DriverOpts": null
                }
            }
        }
    }
]
```

##### Obtenir les logs/journal d’événements : `docker logs <id-container/name>`

```
[11-Sep-2023 12:27:43] NOTICE: fpm is running, pid 1
[11-Sep-2023 12:27:43] NOTICE: ready to handle connections
172.18.0.2 -  11/Sep/2023:12:38:02 +0000 "GET /index.php" 200
172.18.0.2 -  11/Sep/2023:12:54:12 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:12:54:24 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:13:03:30 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:13:10:50 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:13:11:04 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:13:12:19 +0000 "GET /gabarit.php" 200
172.18.0.2 -  11/Sep/2023:13:29:23 +0000 "GET /gabarit.php" 200
[13-Sep-2023 13:54:48] NOTICE: fpm is running, pid 1
[13-Sep-2023 13:54:48] NOTICE: ready to handle connections
172.18.0.3 -  13/Sep/2023:14:23:33 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:23:40 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:23:53 +0000 "GET /gabarit.php" 200
172.18.0.3 -  13/Sep/2023:14:24:21 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:31:50 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:32:20 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:32:56 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:33:32 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:33:48 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:33:55 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:41:15 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:41:28 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:41:35 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:42:19 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:42:58 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:43:05 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:43:35 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:43:48 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:43:53 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:43:58 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:51:59 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:52:24 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:52:40 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:53:40 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:54:43 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:56:08 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:56:23 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:56:30 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:56:35 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:06 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:07 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:17 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:19 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:30 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:57:49 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:59:04 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:14:59:23 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:15:08:11 +0000 "GET /index.php" 200
172.18.0.3 -  13/Sep/2023:15:08:13 +0000 "GET /voirMessages.php" 200
172.18.0.3 -  13/Sep/2023:15:10:12 +0000 "GET /voirMessages.php" 200
172.18.0.3 -  13/Sep/2023:15:10:17 +0000 "GET /voirMessages.php" 200
```

---

### Accéder à un container

##### Exécuter un container en mode interactif : `docker exec -it <id-container/name> <executable>`

```bash
$ docker exec -it ubuntu bash
root@f4db6d60e9b5:/# 
```

##### Exécuter un container et se rattacher via le terminal avec un utilisateur précis : `docker exec -it --user <user-id> <id-container/name> <executable>`

```
$ docker exec -it --user 0 ubuntu bash
root@f4db6d60e9b5:/# 
```

*On se connectera forcement à l'utilisateur `root` avec cette commande. Root étant l'utilisateur d'id 0*
##### Rattacher le terminal à un container `docker attach <id-container/name>`

```
$ docker attach ubuntu
root@84bc8436dfc7:/# 
```

>[!important] Pour se déconnecter d'un container sans l'arrêter : `Ctrl P + Ctrl Q`

---

### Persistance des données et Docker

Afin de pouvoir sauvegarder les données générées/utilisées/modifiées par Docker, on doit créer un volume. Il existe aussi les **bind point** qui sont des liens (similaire à un symlink) entre point de montage de la machine hôte et le container. 

Les volumes eux permettent de synchroniser des dossiers entre l'hôte et le container et c'est ainsi qu'on conservera les modifications après l'arrêt du container. C'est dans des volumes qu'on sauvegardera le contenu de base de données, les logs, les data-sets etc...

Pour monter un volume lors de l'exécution d'un container on peut utiliser l'option `-v` :

```
$ docker run -it -p 80:80 -v /home/altaks/Documents/cours/:/srv/data --name ubuntu ubuntu
root@384b98957417:/# ls /srv/data
Cours-IUT  IUT
root@384b98957417:/# 
```

On voit ici qu'on a monté le dossier `~/Documents/cours/` dans le dossier `/srv/data` du côté container. C'est pour ça que ce dossier est accessible depuis le mode interactif du Docker.

>[!important] Les volumes sont gérés de manière indépendantes par Docker, ils sont plus faciles à sauvegarder ou migrer que les bind points.
##### Créer un volume : `docker volume create <vol-name>`

```
$ docker volume create temp
temp
```
##### Faire la liste des volumes disponibles : `docker volume ls`

```
$ docker volume ls
DRIVER    VOLUME NAME
local     5b94e71541d5049f2c7df3c3b7bfd16f2d306afd287208de69924c3106b74a0b
local     temp
```
##### Inspecter un volume Docker `docker volume inspect <vol-name>`

```
$ docker volume inspect temp
```
```json
[
    {
        "CreatedAt": "2023-09-18T06:51:25Z",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/temp/_data",
        "Name": "temp",
        "Options": null,
        "Scope": "local"
    }
]
```

##### Supprimer un volume existant : `docker volume rm <vol-name>`

```
$ docker volume rm temp
temp
```

##### Monter un volume déjà existent sur un container : `docker run --mount=source=<vol-name>,target=<path> ...` ou `docker run -v <vol-name>:<container-path>`

L'utilisation de `--mount` est meilleure au niveau sémantique mais `-v` est tout aussi explicite.
Les volumes créés manuellement sont en read/write par défaut mais peuvent être placés en read-only, en distant (ssh/ftp) ou exportés.

##### Les bind points VS les Volumes

Les bind points servent à exécuter du code dans un conteneur (très utile dans le cas d'un développement d'application), ils sont généralement spécifiés dans le `docker run`, ex: 

```bash
docker run -v <host-path>:<container-path> <image>
```

Les volumes eux servent plutôt aux autres usages, par exemple des emplacements partagés entre plusieurs containers.

---

### Récapitulatif rapide 

Généralement une commande docker sera composée des paramètres suivants après `docker run ...` : 

| Paramètre                         | Description                                                          |
| --------------------------------- | -------------------------------------------------------------------- |
| `-d`                              | Lancement détaché du terminal                                        |
| `--name <name>`                   | Attribuer un nom human-friendly au container                         |
| `-v <host>:<container>`           | Monter un bind point ou un volume en fonction des cas                |
| `-p <host-port>:<container-port>` | Mapper les ports du container aux ports de l'hôte                    |
| `--rm`                            | Supprime automatiquement le container à la fin de son fonctionnement |

Exemple : 

```bash
docker run -d -p 80:80 -p 3306:3306 --name lamp -v /srv/web:/var/www/html lamp
```

