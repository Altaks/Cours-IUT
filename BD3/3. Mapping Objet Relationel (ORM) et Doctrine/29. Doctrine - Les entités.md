>[!tip] Définition
>Les entités sont des objets PHP qui peuvent être identifiés sur de nombreuses requêtes par un identifiant unique ou une clé primaire 
>
>Une entité contient des propriété persistantes. Une propriété persistante est une variable d'instance de l'entité qui est enregistrée et extraite de la base de données par les capacités de mappage de données de Doctrine.

- Les classes entités n'ont pas besoin d'étendre une classe ou une interface de base abstraite

- Une classe entité ne doit pas être finale ou contenir des méthodes finales

- Une classe entité ne doit pas implémenter `clone()` ou `wakeup()`, à moins qu'il ne le fasse en toute sécurité.

- Il y a encore [beaucoup de règles concernant les entités](https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/basic-mapping.html#quoting-reserved-words) dans le framework Doctrine.

### Etats des entités

>[!tip] Définition
>Une instance d'entité peut être caractérisé comme étant : `New`, `Managed`, `Detached`, `Removed`

<center><?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill-opacity="1" color-rendering="auto" color-interpolation="auto" text-rendering="auto" stroke="black" stroke-linecap="square" width="549" stroke-miterlimit="10" shape-rendering="auto" stroke-opacity="1" fill="black" stroke-dasharray="none" font-weight="normal" stroke-width="1" height="425" font-family="'Dialog'" font-style="normal" stroke-linejoin="miter" font-size="12px" stroke-dashoffset="0" image-rendering="auto"> <!--Generated by ySVG 2.6--> <defs id="genericDefs"/> <g> <g text-rendering="geometricPrecision" shape-rendering="geometricPrecision" transform="matrix(2.0516,0,0,2.1976,13.2071,153.6067)"> <g clip-path="url(#clipPath3)"> <svg xml:space="preserve" opacity="1" writing-mode="lr-tb" stop-color="rgb(0, 0, 0)" shape-rendering="auto" glyph-orientation-horizontal="0deg" color-profile="auto" lighting-color="rgb(255, 255, 255)" color="rgb(0, 0, 0)" font-weight="400" alignment-baseline="auto" font-style="normal" version="1.1" color-interpolation-filters="linearrgb" text-anchor="start" stroke-linecap="butt" color-interpolation="srgb" font-variant="normal" word-spacing="normal" fill-opacity="1" text-rendering="auto" clip-path="none" text-decoration="none" letter-spacing="normal" viewBox="-0.875 -0.887 41 48" glyph-orientation-vertical="auto" display="inline" font-size-adjust="none" overflow="hidden" fill="rgb(0, 0, 0)" font-stretch="normal" stroke-dasharray="none" stroke-miterlimit="4" stop-opacity="1" color-rendering="auto" font-size="12" pointer-events="visiblepainted" mask="none" direction="ltr" baseline-shift="baseline" enable-background="new -0.875 -0.887 41 48" fill-rule="nonzero" image-rendering="auto" stroke-dashoffset="0" width="41px" marker-end="none" clip="auto" cursor="auto" stroke="none" filter="none" visibility="visible" kerning="auto" stroke-width="1" font-family="&quot;Arial&quot;,&quot;Helvetica&quot;,sans-serif" flood-opacity="1" clip-rule="nonzero" src="none" height="48px" unicode-bidi="normal" stroke-linejoin="miter" stroke-opacity="1" flood-color="rgb(0, 0, 0)" dominant-baseline="auto" marker-start="none" x="0px" marker-mid="none" y="0px"><defs><clipPath clipPathUnits="userSpaceOnUse" id="clipPath1"><path d="M0 0 L549 0 L549 425 L0 425 L0 0 Z"/></clipPath><clipPath clipPathUnits="userSpaceOnUse" id="clipPath2"><path d="M340 198 L889 198 L889 623 L340 623 L340 198 Z"/></clipPath><clipPath clipPathUnits="userSpaceOnUse" id="clipPath3"><path d="M-6.4375 -69.8978 L261.1602 -69.8978 L261.1602 123.4958 L-6.4375 123.4958 L-6.4375 -69.8978 Z"/></clipPath></defs><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-979.1445" y2="-979.1445" id="svg1.SVGID_1_"> <stop offset="0" style="stop-color:#3C89C9"/> <stop offset="0.1482" style="stop-color:#60A6DD"/> <stop offset="0.3113" style="stop-color:#81C1F0"/> <stop offset="0.4476" style="stop-color:#95D1FB"/> <stop offset="0.5394" style="stop-color:#9CD7FF"/> <stop offset="0.636" style="stop-color:#98D4FD"/> <stop offset="0.7293" style="stop-color:#8DCAF6"/> <stop offset="0.8214" style="stop-color:#79BBEB"/> <stop offset="0.912" style="stop-color:#5EA5DC"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_1_)" d="M19.625,36.763C8.787,36.763,0,34.888,0,32.575v10c0,2.313,8.787,4.188,19.625,4.188 c10.839,0,19.625-1.875,19.625-4.188v-10C39.25,34.888,30.464,36.763,19.625,36.763z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-973.1445" y2="-973.1445" id="svg1.SVGID_2_"> <stop offset="0" style="stop-color:#9CD7FF"/> <stop offset="0.0039" style="stop-color:#9DD7FF"/> <stop offset="0.2273" style="stop-color:#BDE5FF"/> <stop offset="0.4138" style="stop-color:#D1EEFF"/> <stop offset="0.5394" style="stop-color:#D9F1FF"/> <stop offset="0.6155" style="stop-color:#D5EFFE"/> <stop offset="0.6891" style="stop-color:#C9E7FA"/> <stop offset="0.7617" style="stop-color:#B6DAF3"/> <stop offset="0.8337" style="stop-color:#9AC8EA"/> <stop offset="0.9052" style="stop-color:#77B0DD"/> <stop offset="0.9754" style="stop-color:#4D94CF"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_2_)" d="M19.625,36.763c10.839,0,19.625-1.875,19.625-4.188l-1.229-2c0,2.168-8.235,3.927-18.396,3.927 c-9.481,0-17.396-1.959-18.396-3.927l-1.229,2C0,34.888,8.787,36.763,19.625,36.763z"/><path fill="#3C89C9" d="M19.625,26.468c10.16,0,19.625,2.775,19.625,2.775c-0.375,2.721-5.367,5.438-19.554,5.438 c-12.125,0-18.467-2.484-19.541-4.918C-0.127,29.125,9.465,26.468,19.625,26.468z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-965.6948" y2="-965.6948" id="svg1.SVGID_3_"> <stop offset="0" style="stop-color:#3C89C9"/> <stop offset="0.1482" style="stop-color:#60A6DD"/> <stop offset="0.3113" style="stop-color:#81C1F0"/> <stop offset="0.4476" style="stop-color:#95D1FB"/> <stop offset="0.5394" style="stop-color:#9CD7FF"/> <stop offset="0.636" style="stop-color:#98D4FD"/> <stop offset="0.7293" style="stop-color:#8DCAF6"/> <stop offset="0.8214" style="stop-color:#79BBEB"/> <stop offset="0.912" style="stop-color:#5EA5DC"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_3_)" d="M19.625,23.313C8.787,23.313,0,21.438,0,19.125v10c0,2.313,8.787,4.188,19.625,4.188 c10.839,0,19.625-1.875,19.625-4.188v-10C39.25,21.438,30.464,23.313,19.625,23.313z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-959.6948" y2="-959.6948" id="svg1.SVGID_4_"> <stop offset="0" style="stop-color:#9CD7FF"/> <stop offset="0.0039" style="stop-color:#9DD7FF"/> <stop offset="0.2273" style="stop-color:#BDE5FF"/> <stop offset="0.4138" style="stop-color:#D1EEFF"/> <stop offset="0.5394" style="stop-color:#D9F1FF"/> <stop offset="0.6155" style="stop-color:#D5EFFE"/> <stop offset="0.6891" style="stop-color:#C9E7FA"/> <stop offset="0.7617" style="stop-color:#B6DAF3"/> <stop offset="0.8337" style="stop-color:#9AC8EA"/> <stop offset="0.9052" style="stop-color:#77B0DD"/> <stop offset="0.9754" style="stop-color:#4D94CF"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_4_)" d="M19.625,23.313c10.839,0,19.625-1.875,19.625-4.188l-1.229-2c0,2.168-8.235,3.926-18.396,3.926 c-9.481,0-17.396-1.959-18.396-3.926l-1.229,2C0,21.438,8.787,23.313,19.625,23.313z"/><path fill="#3C89C9" d="M19.476,13.019c10.161,0,19.625,2.775,19.625,2.775c-0.375,2.721-5.367,5.438-19.555,5.438 c-12.125,0-18.467-2.485-19.541-4.918C-0.277,15.674,9.316,13.019,19.476,13.019z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-952.4946" y2="-952.4946" id="svg1.SVGID_5_"> <stop offset="0" style="stop-color:#3C89C9"/> <stop offset="0.1482" style="stop-color:#60A6DD"/> <stop offset="0.3113" style="stop-color:#81C1F0"/> <stop offset="0.4476" style="stop-color:#95D1FB"/> <stop offset="0.5394" style="stop-color:#9CD7FF"/> <stop offset="0.636" style="stop-color:#98D4FD"/> <stop offset="0.7293" style="stop-color:#8DCAF6"/> <stop offset="0.8214" style="stop-color:#79BBEB"/> <stop offset="0.912" style="stop-color:#5EA5DC"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_5_)" d="M19.625,10.113C8.787,10.113,0,8.238,0,5.925v10c0,2.313,8.787,4.188,19.625,4.188 c10.839,0,19.625-1.875,19.625-4.188v-10C39.25,8.238,30.464,10.113,19.625,10.113z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="642.8008" x2="682.0508" gradientUnits="userSpaceOnUse" y1="-946.4946" y2="-946.4946" id="svg1.SVGID_6_"> <stop offset="0" style="stop-color:#9CD7FF"/> <stop offset="0.0039" style="stop-color:#9DD7FF"/> <stop offset="0.2273" style="stop-color:#BDE5FF"/> <stop offset="0.4138" style="stop-color:#D1EEFF"/> <stop offset="0.5394" style="stop-color:#D9F1FF"/> <stop offset="0.6155" style="stop-color:#D5EFFE"/> <stop offset="0.6891" style="stop-color:#C9E7FA"/> <stop offset="0.7617" style="stop-color:#B6DAF3"/> <stop offset="0.8337" style="stop-color:#9AC8EA"/> <stop offset="0.9052" style="stop-color:#77B0DD"/> <stop offset="0.9754" style="stop-color:#4D94CF"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><path fill="url(#svg1.SVGID_6_)" d="M19.625,10.113c10.839,0,19.625-1.875,19.625-4.188l-1.229-2c0,2.168-8.235,3.926-18.396,3.926 c-9.481,0-17.396-1.959-18.396-3.926L0,5.925C0,8.238,8.787,10.113,19.625,10.113z"/><linearGradient gradientTransform="matrix(1 0 0 -1 -642.8008 -939.4756)" x1="644.0293" x2="680.8223" gradientUnits="userSpaceOnUse" y1="-943.4014" y2="-943.4014" id="svg1.SVGID_7_"> <stop offset="0" style="stop-color:#9CD7FF"/> <stop offset="1" style="stop-color:#3C89C9"/></linearGradient><ellipse rx="18.396" fill="url(#svg1.SVGID_7_)" ry="3.926" cx="19.625" cy="3.926"/><path fill="#FFFFFF" d="M31.04,45.982c0,0-4.354,0.664-7.29,0.781 c-3.125,0.125-8.952,0-8.952,0l-2.384-10.292l0.044-2.108l-1.251-1.154L9.789,23.024l-0.082-0.119L9.5,20.529l-1.65-1.254 L5.329,8.793c0,0,4.213,0.903,7.234,1.07s8.375,0.25,8.375,0.25l3,9.875l-0.25,1.313l1.063,2.168l2.312,9.645l-0.521,1.416 l1.46,1.834L31.04,45.982z" enable-background="new " opacity="0.24"/></svg> </g> </g> <g fill="rgb(255,204,0)" text-rendering="geometricPrecision" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke="rgb(255,204,0)"> <ellipse rx="64.5" ry="37.5" clip-path="url(#clipPath2)" cx="580.5" cy="405" stroke="none"/> </g> <g text-rendering="geometricPrecision" stroke-miterlimit="1.45" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke-linecap="butt"> <ellipse rx="64.5" fill="none" ry="37.5" clip-path="url(#clipPath2)" cx="580.5" cy="405"/> <text x="552.8584" xml:space="preserve" y="409.1543" clip-path="url(#clipPath2)" font-family="sans-serif" stroke="none">Managed</text> </g> <g fill="rgb(255,204,0)" text-rendering="geometricPrecision" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke="rgb(255,204,0)"> <ellipse rx="64.5" ry="37.5" clip-path="url(#clipPath2)" cx="580.5" cy="252.5" stroke="none"/> </g> <g text-rendering="geometricPrecision" stroke-miterlimit="1.45" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke-linecap="butt"> <ellipse rx="64.5" fill="none" ry="37.5" clip-path="url(#clipPath2)" cx="580.5" cy="252.5"/> <text x="567.4131" xml:space="preserve" y="256.6543" clip-path="url(#clipPath2)" font-family="sans-serif" stroke="none">New</text> </g> <g fill="rgb(255,204,0)" text-rendering="geometricPrecision" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke="rgb(255,204,0)"> <ellipse rx="64.5" ry="37.5" clip-path="url(#clipPath2)" cx="588.7365" cy="570" stroke="none"/> </g> <g text-rendering="geometricPrecision" stroke-miterlimit="1.45" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke-linecap="butt"> <ellipse rx="64.5" fill="none" ry="37.5" clip-path="url(#clipPath2)" cx="588.7365" cy="570"/> <text x="559.7941" xml:space="preserve" y="574.1543" clip-path="url(#clipPath2)" font-family="sans-serif" stroke="none">Detached</text> </g> <g fill="rgb(255,204,0)" text-rendering="geometricPrecision" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke="rgb(255,204,0)"> <ellipse rx="64.5" ry="37.5" clip-path="url(#clipPath2)" cx="808.973" cy="405" stroke="none"/> </g> <g text-rendering="geometricPrecision" stroke-miterlimit="1.45" shape-rendering="geometricPrecision" transform="matrix(1,0,0,1,-340,-198)" stroke-linecap="butt"> <ellipse rx="64.5" fill="none" ry="37.5" clip-path="url(#clipPath2)" cx="808.973" cy="405"/> <text x="780.5463" xml:space="preserve" y="409.1543" clip-path="url(#clipPath2)" font-family="sans-serif" stroke="none">Removed</text> <path fill="none" d="M435.5469 403 L512 403 L516.1206 403" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M516.1206 403 L504.1206 398 L507.1206 403 L504.1206 408 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="461.5912" y="380.2105" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">find()</text> <path fill="none" d="M519.4236 417 L443.5006 417" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M435.5006 417 L447.5006 422 L444.5006 417 L447.5006 412 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="463.1389" y="451.1543" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">flush()</text> <path fill="none" d="M580.5 290 L580.5 359.5" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M580.5 367.5 L585.5 355.5 L580.5 358.5 L575.5 355.5 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="525.5801" y="332.9043" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">persist()</text> <path fill="none" d="M588.7365 442.2217 L588.7365 524.5" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M588.7365 532.5 L593.7365 520.5 L588.7365 523.5 L583.7365 520.5 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="615.502" y="511.6699" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">Sortie du contexte</text> <text x="626.8662" y="525.6387" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">de persistence</text> <path fill="none" d="M567 534.7239 L567 449.681" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M567 441.681 L562 453.681 L567 450.681 L572 453.681 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="512.8154" y="522.6699" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">merge()</text> <path fill="none" d="M641.5884 417 L739.8735 417" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M747.8735 417 L735.8735 412 L738.8735 417 L735.8735 422 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="682.2777" y="451.1543" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">remove()</text> <path fill="none" d="M744.473 405 L653.0225 405" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M645.0225 405 L657.0225 410 L654.0225 405 L657.0225 400 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="684.3676" y="379.1543" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">persist()</text> <path fill="none" d="M724.0001 252.5 L653 252.5" clip-path="url(#clipPath2)" stroke="rgb(255,153,0)"/> <path fill="rgb(255,153,0)" d="M645 252.5 L657 257.5 L654 252.5 L657 247.5 Z" clip-path="url(#clipPath2)" stroke="none"/> <text x="679.445" y="226.6543" clip-path="url(#clipPath2)" fill="red" font-family="sans-serif" stroke="none" xml:space="preserve">new()</text> </g> </g></svg></center>

- Une instance d'entité `New` n'a pas d'identité persistance et n'est pas encore associée à un `EntityManager` et à un `UnitOfWork` (c'est à dire ceux qui viennent d'être créés par l'opérateur PHP `new`).

- Une instance d'entité `Managed` est une instance avec une identité persistante qui est associée à un `EntityManager` et dont la persistance est ainsi gérée.

- Une instance d'entité `Detached` est une instance avec une entité persistante qui n'est pas (ou plus) associée à un `EntityManager` et à un `UnitOfWork`.

- Une instance d'entité `Removed` est une instance avec une identité persistante, associée à un `EntityManager`, qui sera supprimée de la base de données lors de la validation de la transaction.

### Entités et champs persistants

- L'état persistant d'une entité est représenté par des variables d'instance
  
- Une variable d'instance doit être directement accessible à partir des méthode de l'entité par l'instance de l'entité elle-même.
  
- Les variables d'instance ne doivent pas être accessibles par les clients de l'entité. L'état de l'entité (les valeurs brutes) n'est accessible aux clients (autres entités/instances) qu'au travers de méthodes de l'entité (c'est à dire des accesseurs/mutateurs) ou d'autres méthodes métier.
  
- Les champs et propriétés persistants à valeur de collection/listes doivent être définis en utilisant l'interface `Doctrine\Common\Collections\Collection`.
  
- Le type d'implémentation de collection peut être utilisé par l'application pour initialiser des champs ou des propriétés avant que l'entité ne devienne persistante. Une fois que l'entité devient gérée (ou détachée), l'accès ultérieur doit se faire via le type d'interface

### Gestionnaire des entités : `EntityManager`

>[!important] La classe `EntityManager` est un point d'accès central aux fonctionnalités fournies par Doctrine ORM.

>[!important] L'API `EntityManager` est utilisée pour gérer la persistance des objets et pour rechercher les objets persistants.

### L'unité de travail : `UnitOfWork`

En interne, une `EntityManager` utilise un `UnitOfWork`, qui est une implémentation typique du modèle d'unité de travail, pour garder une trace de toutes les choses qui doivent être faites la prochaine fois que la fonction `flush()` est appelée.

Vous n’interagissez généralement pas directement avec un `UnitOfWork` mais avec l'`EntityManager`.

### Ecriture différée transactionnelle

Une `EntityManager` et le sous-jacent `UnitOfWork` utilisent une stratégie appelée "Ecriture différée transactionnelle" qui retarde l'exécution des instructions SQL afin de les exécuter de la manière la plus efficace et de les exécuter à la fin d'une transaction afin que tous les [[16. Synthèse des différents types de verrous|verrous en écriture]] soient rapidement libérés.

Vous devriez voir Doctrine comme un outil pour synchroniser vos objets en RAM avec la base de donnée dans des unités de travail bien définies.

Travaillez avec vos objets et modifiez-les comme d'habitude, et lorsque vous avez terminé, appelez `EntityManager#flush()` pour rendre vos modifications effectives et persistantes.

### Ce qu'on doit absolument maîtriser

- Comment créer les objets PHP pouvant être enregistrés dans la base de données avec Doctrine

- Comment configurer le mappage entre les colonnes sur les tables et les propriétés sur les entités

- Quels sont les types de mappage Doctrine.

- Comment fonctionne la citation de symboles réservés dans Doctrine.

**Cours à voir :**
- [[30. Doctrine - Mapping fondamental]]