L'outil `EXPLAIN` donne le plan d'exécution d'une requête. La description comprend : 

- Le chemin d'accès utilisé
- Les opérations physiques (tri, fusion, intersection, ...)
- L'ordre des opérations

Cet outil permet de comprendre les actions d'Oracle lors d'une requête LMD afin d'améliorer la rapidité d'exécution.

L'une des méthodes pour améliorer les performances des requêtes SQL sous oracle est l'utilisation d'[[35. Index - Vue d'ensemble|index]].

Les index sont indépendants logiquement et physiquement des tables qu'ils indexent. On peut donc en créer et en supprimer à tout moment car ils n'ont aucun effet sur les tables de base ou d'autres index.

### Comment faire pour générer un plan d'exécution

Pour afficher le plan d'exécution, on dispose de 2 méthodes : 

- La commande `SET AUTOTRACE ON`, suivi des requêtes que l'on souhaite faire
- La commande `EXPLAIN PLAN FOR <request>`

### La commande `AUTOTRACE`

Cette commande permet d'obtenir le plan d'exécution lorsqu'une requête est exécutée.

Dans SQL\*Plus il est possible d'obtenir directement le plan d'exécution et des statistiques avec la commande `AUTOTRACE`

La commande s'utilise tout simplement en exécutant `SET AUTOTRACE <arg>` dans la console SQL.

**Syntaxe SQL :**

```SQL
SET AUTOT[RACE] {OFF | ON | TRACE[ONLY]} 
[EXP[LAIN]]
[STAT[ISTICS]]
```

| Argument     | Description                                                                                                     |
| :------------: | --------------------------------------------------------------------------------------------------------------- |
| `OFF`        | Désactive le suivi d'exécution automatique des instructions SQL                                                 |
| `ON`         | Active le suivi d'exécution automatique des instructions SQL                                                    |
| `TRACEONLY`  | Active le suivi d'exécution automatique des instructions SQL et supprime la sortie (le résultat) de l'affichage |
| `EXPLAIN`    | Affiche les plans d'exécutions mais pas les statistiques                                                        |
| `STATISTICS` | Affiche les statistiques mais pas les plans d'exécution                                                                                                                |

Si les deux dernières options sont omises, les statistiques et les plans d'exécutions sont affichés par défaut.

>[!tip] Astuce
>On peut connaître le temps précis d'une requête (temps exprimé en centième de seconde) par la commande : 
>```SQL
> SET TIMING ON;
> ```
> 
> Ce qui donne un résultat similaire à :
> 
> ```
> Ecoulé : 00:00:01.29
> ```

### La commande `EXPLAIN PLAN`

Oracle fournit sous SQL\*Plus un outil, `EXPLAIN`, qui donne une description du plan d'exécution choisi par le système pour une requête quelconque.

`EXPLAIN PLAN` est une commande qui permet d'expliquer le plan d'exécution ou le chemin d'accès que l'optimiseur va utiliser pour exécuter la commande SQL.

Les résultats de la commande `EXPLAIN PLAN` sont mis dans la table `PLAN_TABLE`.

**Syntaxe SQL :**

```SQL
EXPLAIN PLAN
[SET STATEMENT ID = 'text']
[INTO <[schema.]table_name>[@<dblink>]]
FOR <statement>
```

**`SET`** :

> Specifies the value of `STATEMENT_ID` column for the rows of the execution plan in the output table. If you omit this clause, the `STATEMENT_ID` value defaults to `NULL`.

**`INTO`** : 

> Specifies the schema, name, and database containing the output table.
> This table must exist before you use the `EXPLAIN PLAN` command. If you omit schema, Oracle assumes the table is in your own schema.

**`FOR`** : 

> Specifies a `SELECT`, `INSERT`, `UPDATE` or `DELETE` statement for which the execution plan is generated.

### Que doit-on faire pour la génération d'un plan d'exécution

Les différentes étapes avant d'utiliser la commande `EXPLAIN PLAN` sont : 

1. Créer une table (`PLAN_TABLE`) destinée à contenir toutes les informations relatives à un plan d'exécution
2. Exécuter une requête en demandant le stockage des explications relatives à cette requête dans la table précédemment créée.
3. Interroger la table précédemment remplie pour connaître le plan d'exécution

```SQL
SELECT * FROM table(DBMS_XPLAN.Display);
```

Le fichier de création de la table `PLAN_TABLE` table se trouve généralement dans `$ORACLE_HOME/rdbms/admin`.

Si on utilise un client pour se connecter à la base de données distante, on doit le copier et l'exécuter à distance avec ce client dans son propre schéma de la base de données.

```SQL
DROP TABLE PLAN_TABLE;

@ $ORACLE_HOME/rdbms/admin/utlxplan.sql
```

Le schéma de cette table est donné à la [[47. Schéma de la table PLAN_TABLE et ses opérations|fin de ce cours]].

### Note concernant l'utilisation de `AUTOTRACE`

Pour utiliser cette commande, le DBA (Data Base Administrator) doit d'abord créer le rôle `PLUSTRACE` dans votre instance de la base de données, et vous [[5.10 Les rôles|accorder ce rôle]].

Le rôle `PLUSTRACE` vous donne les privilèges nécessaires pour l'interrogation du dictionnaire de données Oracle.

Le fichier permettant la création de ce rôle se nomme `plustrace.sql` et se trouve *généralement* à `$ORACLE_HOME/sqlplus/admin` .

**Cours à voir :**
- [[46. Savoir lire le plan d'exécution - Application]]