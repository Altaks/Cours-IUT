### Création de trigger `STATEMENT`

Un trigger `BEFORE` permet d'empêcher l'exécution de certaines requêtes si une condition n'est pas respectée. 

On va ainsi créer un trigger pour restreindre les ordres `INSERT` sur la table `emp` aux heures ouvrées entre Lundi et Vendredi.

*Qui serait assez fou pour faire des modifs le weekend ou la nuit ?? allez jouer plutôt :D*

```SQL
CREATE OR REPLACE TRIGGER trigger_secure_emp
BEFORE INSERT ON emp
BEGIN
	IF(
		(TO_CHAR(sysdate, 'DY') IN ('SAM','DIM'))
		OR 
		(TO_CHAR(sysdate, 'HH24') NOT BETWEEN '08' AND '18')
	) THEN
		RAISE_APPLICATION_ERROR(-20500, 'Insertion dans EMP impossible hors des heures de travail')
	ENDIF;
END;
/
```

>[!attention] Choix des codes d'erreurs sur Oracle : 
>Les codes d'erreurs 0 à 20 000 sont réservés par Oracle, veuillez utiliser des codes d'erreurs entre -20 000 et 0 ou supérieurs à 20 000 pour des codes d'erreurs personnalisés. 

>[!important] La fonction `RAISE_APPLICATION_ERROR(err_code, msg)`
>Cette fonction est une procédure serveur intégrée qui affiche un message sur le terminal et cause l'échec du trigger.
>
>**Quand un trigger de base de données échoue, l'évènement déclenchant est automatiquement annulé**

Pour tester le trigger `trigger_secure_emp` on va essayer d'insérer des lignes dans la table `emp` hors des heures de travail : 

```
SQLPLUS> INSERT INTO emp(empno, ename, deptno) VALUES (7777, 'BAUWENS', 40);

INSERT INTO emp(empno, ename, deptno)
            *
ERREUR à la ligne 1 : 
ORA-20500 : Insertion dans EMP impossible hors des heures de travail
ORA-06512 : à "TRIGGER_SECURE_EMP", ligne 5
ORA-04088 : Erreur lors d'exécution du déclencheur 'TRIGGER_SECURE_EMP'
```

---

### Attributs conditionnels :

Il est possible de combiner plusieurs évènements déclenchant une seule déclaration grâce aux attributs conditionnels : `INSERTING`, `UPDATING`, `DELETING` à l'intérieur du corps du trigger.

Ces attributs sont inclus dans des expressions conditionnelles du type `IF-THEN-ELSE`.

On peut par exemple créer un trigger qui restreindra toutes les opérations de manipulation de données (pas uniquement les inserts) sur la table `EMP` aux heures de travail entre Lundi et Vendredi :

```sql
CREATE OR REPLACE TRIGGER trigger_secure_emp
BEFORE INSERT OR UPDATE OR DELETE ON emp
BEGIN
	IF(
		(TO_CHAR(sysdate, 'DY') IN ('SAM','DIM'))
		OR 
		(TO_CHAR(sysdate, 'HH24') NOT BETWEEN '08' AND '18')
	) THEN
		IF DELETING THEN
			RAISE_APPLICATION_ERROR(-20502, 'Suppression dans EMP impossible hors des heures de travail')
		ELSIF UPDATING('salary') THEN 
			RAISE_APPLICATION_ERROR(-20500, 'Mise à jour des salaires dans EMP impossible hors des heures de travail')
		ELSIF INSERTING THEN 
			RAISE_APPLICATION_ERROR(-20503, 'Insertion dans EMP impossible hors des heures de travail')
		ELSE RAISE_APPLICATION_ERROR(-20504, 'Mise à jour dans EMP impossible hors des heures de travail')
		ENDIF;
	ENDIF;
END;
/
```

