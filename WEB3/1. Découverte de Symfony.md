>[!warning] Ces instructions nécessitent l'utilisation d'une stack Docker appartenant à l'IUT La Rochelle, si vous souhaitez installer Symfony par vous même, vous pouvez choisir parmi les options suivantes : 

- Installation Symfony classique : https://symfony.com/doc/current/setup.html
- Installation Symfony sous Docker : https://github.com/dunglas/symfony-docker
### Création du projet Symfony

Configuration de Git :

```bash
docker exec -it iut-php git config --global user.email 'votre@email.org'
docker exec -it iut-php git config --global user.name 'Votre Nom' 
```

Création du projet dans le dossier `projet` : 

```shell
docker exec -it iut-php symfony new projet --version="6.3.*" --webapp
```

La syntaxe générale étant : 

```shell
docker exec -it iut-php symfony new <dossier> --version="6.3.*" --webapp
```

### Revue de l'arborescence créée : 

| Arborescence | Description |  
| -------------|-------------|  
| `/bin` | Contient les exécutables liés au projet (les programmes) |  
| `/config` | Contient la configuration de Symfony |  
| `/public` | Contient les fichiers qui sont disponibles sur le site web |  
| `/src` | Contient les fichiers sources |
| `/templates` | Contient les modèles du site Web |  
| `/tests` | Contient les tests unitaires |  
| `/var` | Contient les fichiers générés par symfony |  
| `/vendor` | Contient les bibliothèques tierces |

Le rôle du fichier `.env` est de contenir les variables d'environnement de fonctionnement de Symfony  

### Le contrôleur frontal : `index.php`

Le contrôleur frontal est le point d’entrée de l’application. 

Dans Symfony le contrôleur frontal se situe dans le répertoire `/public`; il s’agit du fichier `index.php`.

Quel est le rôle de ce contrôleur frontal ? : il appelle le Kernel (noyau) de Symfony pour
obtenir une réponse HTTP suite à la requête HTTP reçue.

Il y a deux environnements de travail, un environnement de développement et un
environnement de production, voir le fichier `.env`

Tous les changements doivent être faits dans l'environnement de développement, l'environnement de production est géré par Symfony.

>[!done] Vous pouvez vérifier que votre installation fonctionne en allant à l'adresse `localhost:8888` ou `127.0.0.1:8888` (sur linux)

### Parcours d'une requête Symfony

- Le visiteur demande la page `/homr`

- Le contrôleur frontal reçoit la requête, charge le Kernel et la lui transmet.
   
- Le Kernel demande au routeur quel contrôleur exécuter pour l’URL `/home` le routeur répond qu’il faut utiliser le contrôleur du bundle Front appelé `HomeController`. (le routeur est un composant Symfony qui fait la correspondance entre URL et contrôleur)

- Le Kernel exécute donc ce contrôleur, qui transmet la vue `/home/home.html.twig` à bundle Twig pour qu’elle construise (avec les arguments passés par la méthode du contrôleur) la page html et la lui retourne.

- Le contrôleur envoie au visiteur la page html complète.

>[!tip] Respect du modèle MVC
>Cette organisation respecte avec brio le Modèle Vue-Contrôleur : 
>- Les vues sont des fichiers Twig situés dans `/templates`
>- Les contrôleurs sont des fichiers php situés dans `/src/Controller`

### Lister les routes

La commande 

```shell
php bin/console debug:router
```

renvoie la liste de toutes les routes actives d'après Symfony, et le résultat **ressemble** à ceci : 

```
 -------------------------- -------- -------- ------ ----------------------------------- 
  Name                       Method   Scheme   Host   Path                               
 -------------------------- -------- -------- ------ ----------------------------------- 
  _preview_error             ANY      ANY      ANY    /_error/{code}.{_format}           
  _wdt                       ANY      ANY      ANY    /_wdt/{token}                      
  _profiler_home             ANY      ANY      ANY    /_profiler/                        
  _profiler_search           ANY      ANY      ANY    /_profiler/search                  
  _profiler_search_bar       ANY      ANY      ANY    /_profiler/search_bar              
  _profiler_phpinfo          ANY      ANY      ANY    /_profiler/phpinfo                 
  _profiler_xdebug           ANY      ANY      ANY    /_profiler/xdebug                  
  _profiler_search_results   ANY      ANY      ANY    /_profiler/{token}/search/results  
  _profiler_open_file        ANY      ANY      ANY    /_profiler/open                    
  _profiler                  ANY      ANY      ANY    /_profiler/{token}                 
  _profiler_router           ANY      ANY      ANY    /_profiler/{token}/router          
  _profiler_exception        ANY      ANY      ANY    /_profiler/{token}/exception       
  _profiler_exception_css    ANY      ANY      ANY    /_profiler/{token}/exception.css   
  app_bonjour                ANY      ANY      ANY    /bonjour/{nom}                     
  detail_evt                 ANY      ANY      ANY    /detailevt/{id}                    
  detail_evt_pass            ANY      ANY      ANY    /detailevtpass/{id}                
  detail_evt_prop            ANY      ANY      ANY    /detailevtprop/{id}                
  detail_session             ANY      ANY      ANY    /detailsession/{id}                
  add                        ANY      ANY      ANY    /add                               
  add_prop                   ANY      ANY      ANY    /addprop                           
  listevt                    ANY      ANY      ANY    /listevt/{titre}                   
  app_index                  ANY      ANY      ANY    /                                  
  app_liste_membre           ANY      ANY      ANY    /listemembres                      
 -------------------------- -------- -------- ------ ----------------------------------- 
```

### Création d'une première page

Utilisez le générateur pour créer un nouveau contrôleur : 

```shell
php bin/console make:controller <nom_du_contrôleur>
```

Ce contrôleur va apparaître avec une méthode `index` par défaut : 

```php

// Inclusion dans l'espace de noms Controller de l'App
namespace App\Controller;  

// Importations de classes PHP
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;  
use Symfony\Component\HttpFoundation\Response;  
use Symfony\Component\Routing\Annotation\Route;  

// Définition d'un contrôleur sur la base d'AbstractController (l'interface)
class IndexController extends AbstractController  
{  
	// Définition de la route '/', avec comme nom de route app_index
    #[Route('/', name: 'app_index')]  
    public function index(): Response  // La méthode renvoie un type Response
    {  
	    // La méthode renvoie le render du controlleur de la vue `index.html.twig` avec comme paramètre `controller_name` qui vaut 'IndexController'
        return $this->render('index/index.html.twig', [  
            'controller_name' => 'IndexController',  
        ]);  
    }  
}
```

Une fois ceci fait et **sauvegardé**, vous pouvez d'ores et déjà accéder à cette page en allant à l'adresse `localhost:8888/`.
### Routage

On peut créer une nouvelle route sur notre site, par exemple `localhost:8888/bonjour`, qui s'appellera `app_bonjour` : 

Il nous faut alors créer un contrôleur `BonjourController` avec la commande : 

```shell
php bin/console make:controller BonjourController
```

Il créera une méthode `index` par défaut dans le fichier `BonjourController` : 

```php
<?php  
  
namespace App\Controller;  
  
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;  
use Symfony\Component\HttpFoundation\Response;  
use Symfony\Component\Routing\Annotation\Route;  
  
class BonjourController extends AbstractController  
{  
    #[Route('/bonjour', name: 'app_bonjour')]  
    public function index(string $nom): Response  
    {  
        return $this->render('bonjour/index.html.twig', [  
            'controller_name' => 'BonjourController',
        ]);  
    }  
}
```

### Route paramétrée

Dans le cas ou nous voudrions ajouter des paramètres à notre route, nous pouvons utiliser une route paramétrée, et placer des valeurs par défaut si jamais ces paramètres ne sont pas indiqués : 

On modifie le contrôleur : 

```php
#[Route('/bonjour/{nom?inconnu}', name: 'app_bonjour')]  
public function index(string $nom): Response  
{  
	return $this->render('bonjour/index.html.twig', [  
		'controller_name' => 'BonjourController',  
		'nom' => $nom,  
	]);  
}  
```

On voit dans la définition de la route l'ajout du paramètre `{nom?inconnu}`: 

```
#[Route('/bonjour/{nom?inconnu}', name: 'app_bonjour')]  
```

On voit donc le paramètre `nom`, dont la valeur par défaut est `inconnu`. La valeur par défaut est séparée par un `?` du paramètre, et ces deux valeurs doivent être englobées par des accolades.

Voici la structure d'un paramètre de route : 

| Structure                  | Utilisation                                              |
| -------------------------- | -------------------------------------------------------- |
| `{variable?valeur_defaut}` | La variable est définie et possède une valeur par défaut |
| `{variable?}`              | La variable est définie mais elle peut valoir `null`     |
| `{variable}`               | La variable ne peut pas être `null`                                                         |

>[!warning] La méthode aussi change !
>Vous l'aurez sûrement remarqué mais ce changement est tout aussi primordial au bon déroulement du routage.
>
>La méthode `index` a gagné un argument : `string $nom` qui va contenir la valeur utilisée par le visiteur du site à l'emplacement du paramètre `nom`.
>
>Dans le cas d'une variable qui peut être `null`, il faut indiquer un `?` **devant** le type, exemple : `?string $nom`.
>
>Une fois ce changement fait, vous pouvez manipuler le contenu de la variable `nom` pour vos calculs/appels à la base de donnée par exemple.

### Le contrôleur et le profiler

**Rôle du contrôleur** : s’occupe de la logique de l’application, il traite les requêtes HTTP et retourne les réponses. Pour cela il va demander des services et appeler les vues en leur transmettant les données à mettre en forme.

Le contrôleur manipule les requêtes qui lui sont fournies par le composant [**HttpFoundation**](http://symfony.com/doc/current/components/http_foundation.html) 

Symfony fournit également un profiler de page (Appuyez sur le 200 en bas à gauche de votre page :D) qui permet d'étudier le comportement et le contenu de la requête, ainsi que de la réponse déterminée par Symfony 

Le profiler indique énormément de données en fonction de ce qui a été fait : 

- La requête HTTP
- La réponse HTML
- Les performances du serveur
- Les logs du serveur Symfony
- La logique de Routing
- Le traitement de Twig
- Les échanges avec la base de données (Doctrine)
- Les traitements d'Emails
- Les validations (Validator)
- La gestion des exceptions
- La gestion des formulaires
- La configuration